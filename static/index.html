<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <canvas id="realCanvas"></canvas>

    <div id="clickToContinueOverlay">
        <button id="clickToContinueButton">Turn on the TV</button>
        <br />
        <p>In short, Audio Context can only be started <i>after</i> a user interaction...</p>
        <p>So yeah, please click the button...</p>
        <p>If there's a way around this please, <i>PLEASE</i> <a href="https://github.com/curzel-it/tama/issues/new">let me know</a>!</p>
    </div>

    <div id="authControls">
        <span id="channelName" style="display: none;"></span>
        <button id="logoutButton" onclick="handleLogout()" style="display: none;">Logout</button>
        <button id="createButton" onclick="handleCreateClick()" style="display: none;">Create</button>
        <button id="loginButton" onclick="showAuthModal()" style="display: none;">Login</button>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideAuthModal()">&times;</span>
            <h2>Login or Sign Up</h2>
            <div id="mobileNotice" style="display: none; padding: 15px; margin-bottom: 15px; background: var(--background-secondary); border-radius: 8px;">
                <p style="margin: 0 0 10px 0;"><strong>üì± Mobile users:</strong></p>
                <p style="margin: 0;">Content creation is only available on desktop. A mobile app is coming soon!</p>
                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.8;">You can still browse and enjoy content on mobile.</p>
            </div>
            <div id="authError" class="error" style="display: none;"></div>
            <form id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label for="authChannelName">Channel Name</label>
                    <input type="text" id="authChannelName" pattern="[^\s]+" required>
                    <small>No spaces, max 250 characters</small>
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" required>
                </div>
                <button type="submit">Continue</button>
            </form>
        </div>
    </div>

    <div id="createChoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideCreateChoiceModal()">&times;</span>
            <h2>Create Content</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <a href="/content-editor.html" class="button" style="display: block; text-align: center; text-decoration: none; padding: 10px 20px;">Create Content (Pixel Art + MIDI)</a>
                <button onclick="showUploadModal()">Upload .txt Files</button>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideUploadModal()">&times;</span>
            <h2>Upload Content</h2>
            <div id="uploadError" class="error" style="display: none;"></div>
            <form id="uploadForm" onsubmit="handleUpload(event)">
                <div class="form-group">
                    <label for="spriteFile">Sprite File (.txt)</label>
                    <input type="file" id="spriteFile" accept=".txt" required>
                    <small>Upload a .txt file containing both art and MIDI data</small>
                </div>
                <div id="previewSection" style="display: none; margin: 20px 0;">
                    <div id="fileInfo" style="font-size: 14px; padding: 15px; border: 1px solid; border-radius: 4px;"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit">Publish</button>
                    <button type="button" onclick="hideUploadModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="navigationControls" style="display: none;">
        <div class="controls">
            <button onclick="previousContent()">‚Üê Previous</button>
            <div id="volumeControls">
                <button onclick="decreaseVolume()">-</button>
                <span id="volumeDisplay">+..........</span>
                <button onclick="increaseVolume()">+</button>
                <button onclick="toggleMute()" id="muteButton">Mute</button>
            </div>
            <button onclick="nextContent()">Next ‚Üí</button>
        </div>
    </div>

    <div id="contentContainer">
        <div class="loading">Loading feed...</div>
    </div>

    <script src="/asciiCanvas.js"></script>
    <script src="/ascii.js"></script>
    <script src="/network.js"></script>
    <script src="/auth.js"></script>
    <script src="/create.js"></script>
    <script src="/midi.js" type="module"></script>
    <script src="/main.js" type="module"></script>
    <script type="module">
        import { loadFeed, initializePage } from '/main.js';
        import { midiPlayer } from '/midi.js';

        const turnOnButton = document.getElementById('clickToContinueButton');
        const overlay = document.getElementById('clickToContinueOverlay');

        // Check if this is a direct content link
        const isViewContentUrl = window.location.pathname.match(/\/view\/content\/\d+/);

        turnOnButton.addEventListener('click', async () => {
            midiPlayer.initAudioContext();
            overlay.classList.add('hidden');

            if (isViewContentUrl) {
                await initializePage();
            } else {
                await loadFeed();
            }
        });

        // Initialize auth UI on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            initVolumeControls();
        });

        // Volume control functionality
        const VOLUME_STEPS = 10;
        const VOLUME_STORAGE_KEY = 'tama_volume';
        const MUTE_STORAGE_KEY = 'tama_muted';

        function loadVolumeSettings() {
            const savedVolume = localStorage.getItem(VOLUME_STORAGE_KEY);
            const savedMuted = localStorage.getItem(MUTE_STORAGE_KEY);

            if (savedVolume !== null) {
                const volume = parseFloat(savedVolume);
                midiPlayer.setVolume(volume);
            }

            if (savedMuted === 'true') {
                midiPlayer.mute();
            }
        }

        function saveVolumeSettings() {
            localStorage.setItem(VOLUME_STORAGE_KEY, midiPlayer.getVolume().toString());
            localStorage.setItem(MUTE_STORAGE_KEY, midiPlayer.getMuted().toString());
        }

        window.updateVolumeDisplay = function() {
            const volume = midiPlayer.getVolume();
            const isMuted = midiPlayer.getMuted();
            const steps = Math.round(volume * VOLUME_STEPS);

            const volumeDisplay = document.getElementById('volumeDisplay');
            const muteButton = document.getElementById('muteButton');

            if (volumeDisplay) {
                const filled = '‚îÅ'.repeat(steps);
                const empty = '¬∑'.repeat(VOLUME_STEPS - steps);
                volumeDisplay.textContent = filled + '‚ï∏' + empty;
            }

            if (muteButton) {
                muteButton.textContent = isMuted ? 'Unmute' : 'Mute';
            }
        }

        function initVolumeControls() {
            loadVolumeSettings();
            window.updateVolumeDisplay();
        }

        window.increaseVolume = function() {
            const currentVolume = midiPlayer.getVolume();
            const newVolume = Math.min(1.0, currentVolume + (1.0 / VOLUME_STEPS));
            midiPlayer.setVolume(newVolume);
            saveVolumeSettings();
            window.updateVolumeDisplay();
        }

        window.decreaseVolume = function() {
            const currentVolume = midiPlayer.getVolume();
            const newVolume = Math.max(0.0, currentVolume - (1.0 / VOLUME_STEPS));
            midiPlayer.setVolume(newVolume);
            saveVolumeSettings();
            window.updateVolumeDisplay();
        }

        window.toggleMute = function() {
            midiPlayer.toggleMute();
            saveVolumeSettings();
            window.updateVolumeDisplay();
        }
    </script>
</body>

</html>